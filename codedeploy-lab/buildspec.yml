version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - apt-get update && apt-get install -y zip

  build:
    commands:
      - echo "Creating function.zip..."

      # Get the latest published Lambda version
      - export LAMBDA_VERSION=$(aws lambda list-versions-by-function --function-name codedeploy-lab-function --query "Versions[-1].Version" --output text)

      # Write appspec.yml line-by-line
      - echo "version: 0.0" > codedeploy-lab/appspec.yml
      - echo "Resources:" >> codedeploy-lab/appspec.yml
      - echo "  - MyLambdaFunction:" >> codedeploy-lab/appspec.yml
      - echo "      Type: AWS::Lambda::Function" >> codedeploy-lab/appspec.yml
      - echo "      Properties:" >> codedeploy-lab/appspec.yml
      - echo "        Name: codedeploy-lab-function" >> codedeploy-lab/appspec.yml
      - echo "        Alias: live" >> codedeploy-lab/appspec.yml
      - echo "        CurrentVersion: version-${LAMBDA_VERSION}" >> codedeploy-lab/appspec.yml

      # Zip the function and appspec
      - zip function.zip codedeploy-lab/app.py codedeploy-lab/appspec.yml

artifacts:
  files:
    - function.zip

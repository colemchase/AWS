version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.11
    commands:
      - apt-get update

  build:
    commands:
      - echo "Creating function.zip..."
      - LAMBDA_VERSION=$(aws lambda list-versions-by-function --function-name codedeploy-lab-function --query 'Versions[-1].Version' --output text)
      - |
        echo "version: 0.0" > codedeploy-lab/appspec.yml
        echo "Resources:" >> codedeploy-lab/appspec.yml
        echo "  - MyLambdaFunction:" >> codedeploy-lab/appspec.yml
        echo "      Type: AWS::Lambda::Function" >> codedeploy-lab/appspec.yml
        echo "      Properties:" >> codedeploy-lab/appspec.yml
        echo "        Name: codedeploy-lab-function" >> codedeploy-lab/appspec.yml
        echo "        Alias: live" >> codedeploy-lab/appspec.yml
        echo "        CurrentVersion: version-${LAMBDA_VERSION}" >> codedeploy-lab/appspec.yml
      - zip function.zip codedeploy-lab/app.py codedeploy-lab/appspec.yml

artifacts:
  files:
    - app.py
    - appspec.yml